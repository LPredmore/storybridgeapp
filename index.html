
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>StoryBridge - Story Generator</title>
    <meta name="description" content="Create magical stories for young readers with sight words practice" />
    <meta name="author" content="StoryBridge" />
    <meta name="keywords" content="story generator, sight words, reading, children, education" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8B5CF6" />
    <meta name="background-color" content="#F3E8FF" />
    <meta name="display" content="standalone" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- iOS Specific -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="StoryBridge" />
    
    <!-- Microsoft specific -->
    <meta name="msapplication-TileColor" content="#8B5CF6" />
    <meta name="msapplication-config" content="none" />
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/pwa-512x512.png" color="#8B5CF6" />
    
    <!-- Social Media -->
    <meta property="og:title" content="StoryBridge - Story Generator" />
    <meta property="og:description" content="Create magical stories for young readers with sight words practice" />
    <meta property="og:image" content="/pwa-512x512.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="StoryBridge - Story Generator" />
    <meta name="twitter:description" content="Create magical stories for young readers with sight words practice" />
    <meta name="twitter:image" content="/pwa-512x512.png" />
  </head>

  <body>
    <div id="root"></div>
    
    <!-- Emergency Fallback Screen for Android PWA - Enhanced with JavaScript bundle failure detection -->
    <div id="emergency-fallback" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F3E8FF; z-index: 9999; padding: 20px; font-family: Arial, sans-serif; text-align: center; overflow-y: auto;">
      <div style="max-width: 500px; margin: 20px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h1 style="color: #8B5CF6; margin-bottom: 20px;">🔧 StoryBridge Diagnostics</h1>
        <div id="fallback-info">
          <p style="margin-bottom: 15px; color: #666;">Analyzing app loading status...</p>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 11px; text-align: left; margin: 15px 0; border: 1px solid #e9ecef;">
            <div style="margin: 5px 0;">🌐 <strong>URL:</strong> <span id="current-url"></span></div>
            <div style="margin: 5px 0;">📱 <strong>Device:</strong> <span id="user-agent"></span></div>
            <div style="margin: 5px 0;">🔄 <strong>Service Worker:</strong> <span id="sw-status">Checking...</span></div>
            <div style="margin: 5px 0;">📦 <strong>App Version:</strong> <span id="app-version">Loading...</span></div>
            <div style="margin: 5px 0;">⏰ <strong>Load Time:</strong> <span id="load-time"></span></div>
            <div style="margin: 5px 0;">🎯 <strong>Main Bundle:</strong> <span id="bundle-status">Checking...</span></div>
            <div style="margin: 5px 0;">🌐 <strong>Network:</strong> <span id="network-status">Testing...</span></div>
            <div style="margin: 5px 0;">📱 <strong>PWA Mode:</strong> <span id="pwa-mode">Detecting...</span></div>
          </div>
          <div style="margin: 20px 0;">
            <button onclick="location.reload()" style="background: #8B5CF6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">🔄 Retry</button>
            <button onclick="clearCacheAndReload()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">🗑️ Clear Cache</button>
            <button onclick="forceRefresh()" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px;">⚡ Force Refresh</button>
          </div>
          <div id="error-details" style="background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 5px; font-size: 12px; text-align: left; margin: 15px 0; display: none;">
            <h4 style="color: #dc2626; margin: 0 0 10px 0;">🚨 Error Details:</h4>
            <div id="error-content"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const startTime = Date.now();
      let emergencyShown = false;
      let loadErrors = [];
      
      // Populate emergency diagnostic info immediately
      document.getElementById('current-url').textContent = window.location.href;
      document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 60) + '...';
      document.getElementById('sw-status').textContent = 'serviceWorker' in navigator ? 'Supported ✅' : 'Not Supported ❌';
      document.getElementById('load-time').textContent = new Date().toLocaleTimeString();
      
      // Detect PWA mode
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true ||
                    document.referrer.includes('android-app://');
      document.getElementById('pwa-mode').textContent = isPWA ? 'PWA Mode ✅' : 'Browser Mode 🌐';
      
      // Test network connectivity
      function testNetwork() {
        const networkTest = Date.now();
        fetch('/favicon-16x16.png?t=' + networkTest)
          .then(() => document.getElementById('network-status').textContent = 'Connected ✅')
          .catch(() => document.getElementById('network-status').textContent = 'Connection Issues ❌');
      }
      testNetwork();
      
      // Check for app version
      fetch('/app-version.json?t=' + Date.now())
        .then(r => r.json())
        .then(data => document.getElementById('app-version').textContent = data.version + ' ✅')
        .catch(() => document.getElementById('app-version').textContent = 'Version Error ❌');
      
      // Enhanced cache clearing
      function clearCacheAndReload() {
        if ('caches' in window) {
          caches.keys().then(names => {
            return Promise.all(names.map(name => caches.delete(name)));
          }).then(() => {
            localStorage.clear();
            sessionStorage.clear();
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
              });
            }
            location.reload(true);
          });
        } else {
          localStorage.clear();
          sessionStorage.clear();
          location.reload(true);
        }
      }
      
      // Force refresh with cache bypass
      function forceRefresh() {
        window.location.href = window.location.href + '?t=' + Date.now();
      }
      
      // Track loading errors
      function addError(error) {
        loadErrors.push(error);
        const errorEl = document.getElementById('error-details');
        const contentEl = document.getElementById('error-content');
        errorEl.style.display = 'block';
        contentEl.innerHTML = loadErrors.map(err => `<div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">${err}</div>`).join('');
      }
      
      // Emergency debug activation
      let tapCount = 0;
      let tapTimer = null;
      document.addEventListener('click', function(e) {
        if (e.clientX < 50 && e.clientY < 50) {
          tapCount++;
          clearTimeout(tapTimer);
          tapTimer = setTimeout(() => tapCount = 0, 2000);
          if (tapCount >= 5) {
            document.getElementById('emergency-fallback').style.display = 'block';
            emergencyShown = true;
          }
        }
      });
      
      // Monitor JavaScript bundle loading
      let bundleLoaded = false;
      const bundleTimeout = setTimeout(() => {
        if (!bundleLoaded) {
          document.getElementById('bundle-status').textContent = 'Failed to Load ❌';
          addError('Main JavaScript bundle failed to load within 5 seconds');
        }
      }, 5000);
      
      // Show emergency screen if app doesn't load within 8 seconds (reduced from 10)
      setTimeout(() => {
        if (!emergencyShown && (!document.querySelector('#root > *') || document.querySelector('#root').innerHTML.trim() === '')) {
          console.error('🚨 App failed to load within 8 seconds - showing emergency screen');
          addError('React app failed to render within timeout period');
          document.getElementById('emergency-fallback').style.display = 'block';
          emergencyShown = true;
        }
      }, 8000);
      
      // Debug URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('debug') === 'emergency' || urlParams.get('cache') === 'clear') {
        document.getElementById('emergency-fallback').style.display = 'block';
        emergencyShown = true;
        if (urlParams.get('cache') === 'clear') {
          clearCacheAndReload();
        }
      }
    </script>
    
    <script>
      // Enhanced script loading error detection
      window.addEventListener('error', function(e) {
        console.error('🚨 Script loading error:', e);
        
        let errorMsg = 'Unknown error';
        if (e.filename) {
          if (e.filename.includes('.js')) {
            errorMsg = `JavaScript file failed: ${e.filename}`;
            document.getElementById('bundle-status').textContent = 'Load Error ❌';
          } else {
            errorMsg = `Resource failed: ${e.filename}`;
          }
        } else if (e.message) {
          errorMsg = `Error: ${e.message}`;
        }
        
        addError(errorMsg);
        
        if (e.filename && e.filename.includes('.js')) {
          if (!emergencyShown) {
            document.getElementById('emergency-fallback').style.display = 'block';
            emergencyShown = true;
          }
        }
      });
      
      // Detect when main bundle successfully loads
      window.addEventListener('DOMContentLoaded', function() {
        bundleLoaded = true;
        clearTimeout(bundleTimeout);
        document.getElementById('bundle-status').textContent = 'Loaded ✅';
      });
      
      // Service worker registration with enhanced error handling
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
          .then(registration => {
            console.log('✅ Service Worker registered:', registration.scope);
            document.getElementById('sw-status').textContent = 'Registered ✅';
          })
          .catch(error => {
            console.error('❌ Service Worker registration failed:', error);
            document.getElementById('sw-status').textContent = 'Failed ❌';
          });
      }
    </script>
    
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module" onerror="console.error('❌ GPT Engineer script failed to load')"></script>
    <script type="module" src="/src/main.tsx" onerror="console.error('❌ Main app script failed to load'); addError('Main React app script (main.tsx) failed to load'); document.getElementById('bundle-status').textContent = 'Failed ❌'; if (!emergencyShown) { document.getElementById('emergency-fallback').style.display = 'block'; emergencyShown = true; }"></script>
  </body>
</html>
